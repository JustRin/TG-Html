<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>SCManga Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* Общие стили страницы */
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f2f5;
      color: #333;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background: #4a90e2;
      padding: 20px;
      text-align: center;
      color: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    header h1 {
      margin: 0;
      font-weight: normal;
    }

    /* Контейнер гридом */
    #image-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
      padding: 16px;
      flex: 1;
    }

    /* Карточка-контейнер для каждого изображения */
    .image-wrapper {
      position: relative;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      min-height: 180px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .image-wrapper img {
      max-width: 100%;
      display: block;
      opacity: 0;
      transition: opacity 0.4s ease-in-out;
    }

    /* Спиннер */
    .image-wrapper .spinner {
      position: absolute;
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0,0,0,0.1);
      border-top-color: #4a90e2;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Сообщение об ошибке на картинке */
    .image-wrapper .error {
      position: absolute;
      padding: 8px 12px;
      background: rgba(255,255,255,0.9);
      color: #c00;
      font-size: 14px;
      text-align: center;
      border-radius: 4px;
    }

    /* Футер с кнопкой Telegram */
    footer {
      text-align: center;
      padding: 16px;
      background: #fff;
      box-shadow: 0 -1px 4px rgba(0,0,0,0.05);
    }
    .tg-button {
      display: inline-flex;
      align-items: center;
      background: #0088cc;
      color: white;
      text-decoration: none;
      padding: 12px 20px;
      border-radius: 24px;
      font-size: 16px;
      transition: background 0.3s, transform 0.2s;
    }
    .tg-button:hover {
      background: #0077b3;
      transform: translateY(-2px);
    }
    .tg-button svg {
      width: 20px;
      height: 20px;
      margin-right: 8px;
      fill: white;
    }
  </style>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-M7R29TFD');</script>
    <!-- End Google Tag Manager -->
</head>
<body>

  <header>
    <h1>SCManga: Просмотр картинок</h1>
  </header>

  <div id="image-container">
    <!-- Картинки подгрузятся сюда -->
  </div>

  <footer>
    <a href="https://t.me/SCManga" target="_blank" class="tg-button">
      <svg viewBox="0 0 24 24"><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.896 16.312c-.164.468-.508.84-.972 1.016-.618.234-1.446.178-2.282-.314l-3.72-2.212c-.37-.22-.622-.56-.73-.96l-.566-2.112c-.086-.32-.01-.66.208-.92l3.34-3.16c.316-.3.82-.284 1.12.032.3.316.284.82-.032 1.12l-3.122 2.956.468 1.74 3.38 2.008c.324.192.73.172 1.022-.05.292-.222.462-.578.466-.946l.064-5.614c.004-.404.226-.784.586-.996l3.688-1.722c.41-.192.896.042.998.472l.956 4.14c.102.44.022.902-.216 1.27l-1.656 2.252z"/></svg>
      Подписаться в Telegram
    </a>
  </footer>

  <script>
    async function fetchImages() {
      const params = new URLSearchParams(window.location.search);
      const srcUrl = params.get('url');
      const apiUrl = `https://scmanga.online:3000/get-links?url=${encodeURIComponent(srcUrl)}`;

      const container = document.getElementById('image-container');
      container.innerHTML = '';  // очистим

      try {
        const resp = await fetch(apiUrl);
        if (!resp.ok) throw new Error(`Сервер вернул ${resp.status}`);
        const data = await resp.json();
        if (!Array.isArray(data) || data.length === 0) {
          container.innerHTML = `<div class="error">Нет изображений для отображения.</div>`;
          return;
        }

        // Для каждого URL создаём обёртку
        data.forEach(({ image_url }) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'image-wrapper';

          const spinner = document.createElement('div');
          spinner.className = 'spinner';
          wrapper.appendChild(spinner);

          const img = document.createElement('img');
          wrapper.appendChild(img);

          container.appendChild(wrapper);

          loadWithSpinner(img, spinner, image_url);
        });

      } catch (err) {
        container.innerHTML = `<div class="error">Ошибка: ${err.message}</div>`;
      }
    }

    async function loadWithSpinner(img, spinner, url, tries = 3) {
      for (let i = 1; i <= tries; i++) {
        try {
          await loadImage(url, 6000);
          img.src = url;
          img.onload = () => {
            spinner.remove();
            img.style.opacity = 1;
          };
          return;
        } catch (e) {
          if (i === tries) {
            spinner.remove();
            const err = document.createElement('div');
            err.className = 'error';
            err.textContent = 'Не удалось загрузить';
            img.parentNode.appendChild(err);
          }
          await new Promise(r => setTimeout(r, 1500));
        }
      }
    }

    function loadImage(src, timeout=5000) {
      return new Promise((res, rej) => {
        const img = new Image();
        let done = false;
        const timer = setTimeout(() => {
          if (!done) { done = true; rej(new Error('timeout')); }
        }, timeout);
        img.onload = () => { if (!done) { done = true; clearTimeout(timer); res(); } };
        img.onerror = () => { if (!done) { done = true; clearTimeout(timer); rej(new Error('error')); } };
        img.src = src;
      });
    }

    // Стартуем
    fetchImages();
  </script>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-M7R29TFD"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TVWL57RTT6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-TVWL57RTT6');
</script>

</body>
</html>

