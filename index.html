<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>SCManga Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">

  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-M7R29TFD');</script>
  <!-- End Google Tag Manager -->

  <style>
    :root { --vh: 1vh; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; background: #f0f2f5; font-family: sans-serif; }

    #scrollable {
      height: calc(var(--vh) * 100);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y;
      overscroll-behavior: contain;
      padding-bottom: env(safe-area-inset-bottom);
      scrollbar-width: none; -ms-overflow-style: none;
      width: calc(100% + 20px);
      margin-right: -20px;
      padding-right: 20px;
    }
    #scrollable::-webkit-scrollbar { width: 0; height: 0; }

    #scroll-track {
      position: fixed; top: 0; right: calc(2px + env(safe-area-inset-right));
      width: 8px; height: 100%;
      background: rgba(0,0,0,0.05);
      pointer-events: none; opacity: 0; transition: opacity .4s ease;
      z-index: 999; will-change: opacity;
    }
    #scroll-track .thumb {
      position: absolute; left: 0; width: 100%;
      background: linear-gradient(to bottom, #ff6bd3, #553cff, #34d0ff);
      border-radius: 4px; pointer-events: auto; touch-action: none; cursor: ns-resize; will-change: transform;
    }

    #image-container { display: flex; flex-direction: column; }
    .image-wrapper { position: relative; width: 100%; }
    .image-wrapper img {
      width: 100%; opacity: 0; display: block; transition: opacity .4s ease-in;
      -webkit-touch-callout: none; user-select: none; -webkit-user-drag: none;
    }

    .spinner {
      position: absolute; top: 50%; left: 50%;
      width: 40px; height: 40px; margin: -20px 0 0 -20px;
      border: 4px solid rgba(0,0,0,0.1); border-top-color: #4a90e2;
      border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .error {
      position: relative; margin: 16px auto; background: #fff; color: #c00;
      padding: 10px 12px; border-radius: 8px; font-size: 14px; text-align: center;
      max-width: 560px; box-shadow: 0 2px 8px rgba(0,0,0,.06);
    }

    #page-indicator {
      position: fixed; bottom: calc(20px + env(safe-area-inset-bottom)); left: 50%;
      transform: translateX(-50%); background: rgba(0,0,0,0.6); color: #fff;
      padding: 6px 12px; border-radius: 12px; font-size: 14px; opacity: 0;
      transition: opacity .3s ease-in-out; pointer-events: none; z-index: 1000; will-change: opacity;
    }

    footer {
      margin-top: 16px; padding: 20px 0; background: #fff; text-align: center;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
    }
    .tg-button {
      position: relative; display: inline-flex; align-items: center; gap: 10px;
      background: linear-gradient(135deg,#37aee2 0%,#1f8ecd 100%); color: #fff; text-decoration: none;
      padding: 14px 28px; border-radius: 50px; font-size: 16px; font-weight: 600; overflow: hidden;
      box-shadow: 0 6px 16px rgba(0,0,0,0.15); transition: transform .2s ease, box-shadow .2s ease;
    }
    .tg-button::before {
      content: ''; position: absolute; top: -50%; left: -50%;
      width: 200%; height: 200%; background: rgba(255,255,255,0.15);
      transform: rotate(45deg) translate(-100%,0); transition: transform .7s ease;
    }
    .tg-button:hover::before { transform: rotate(45deg) translate(100%,0); }
    .tg-button:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
    .tg-button:active { transform: translateY(1px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .tg-button svg { width: 40px; height: 40px; fill: #fff; flex-shrink: 0; }
  </style>
</head>
<body>
  <!-- кастомный скролл-трек -->
  <div id="scroll-track"><div class="thumb"></div></div>

  <!-- скроллируемая зона -->
  <div id="scrollable">
    <div id="image-container"></div>
    <footer>
      <a href="https://t.me/SCManga" target="_blank" class="tg-button" rel="noopener">
        <svg viewBox="0 0 256 256" aria-hidden="true">
          <g>
            <path d="M128,0 C57.307,0 0,57.307 0,128 L0,128 C0,198.693 57.307,256 128,256 L128,256 C198.693,256 256,198.693 256,128 L256,128 C256,57.307 198.693,0 128,0 L128,0 Z" fill="#40B3E0"></path>
            <path d="M190.2826,73.6308 L167.4206,188.8978 C167.4206,188.8978 164.2236,196.8918 155.4306,193.0548 L102.6726,152.6068 L83.4886,143.3348 L51.1946,132.4628 C51.1946,132.4628 46.2386,130.7048 45.7586,126.8678 C45.2796,123.0308 51.3546,120.9528 51.3546,120.9528 L179.7306,70.5928 C179.7306,70.5928 190.2826,65.9568 190.2826,73.6308" fill="#FFFFFF"></path>
            <path d="M98.6178,187.6035 C98.6178,187.6035 97.0778,187.4595 95.1588,181.3835 C93.2408,175.3085 83.4888,143.3345 83.4888,143.3345 L161.0258,94.0945 C161.0258,94.0945 165.5028,91.3765 165.3428,94.0945 C165.3428,94.0945 166.1418,94.5735 163.7438,96.8115 C161.3458,99.0505 102.8328,151.6475 102.8328,151.6475" fill="#D2E5F1"></path>
            <path d="M122.9015,168.1154 L102.0335,187.1414 C102.0335,187.1414 100.4025,188.3794 98.6175,187.6034 L102.6135,152.2624" fill="#B5CFE4"></path>
          </g>
        </svg>
        Подпишись на нас в Телеграм,<br>будь в курсе последних глав!
      </a>
    </footer>
  </div>

  <!-- Фиксированный индикатор страницы -->
  <div id="page-indicator"></div>

  <script>
// ===== Глобальные переменные/элементы =====
document.addEventListener('contextmenu', e => { if (e.target.tagName === 'IMG') e.preventDefault(); });
if (!window.Telegram) { window.Telegram = { WebApp: { ready: ()=>{}, disableVerticalSwipes: ()=>{} } }; }

const scrollable = document.getElementById('scrollable');
const track      = document.getElementById('scroll-track');
const thumb      = track.querySelector('.thumb');
const pageInd    = document.getElementById('page-indicator');

let wrappers=[], total=0;

// vh фикс
function updateVh(){ document.documentElement.style.setProperty('--vh',(window.innerHeight*0.01)+'px'); }
window.addEventListener('resize', updateVh); updateVh();

// ===== Настройки API/загрузки =====
const API_ORIGINS = [
  'https://scmanga.online:3000',   // если будет резерв — добавь сюда
];
const API_PATH_GET_LINKS = '/get-links';
const API_PATH_IMG_PROXY = '/img-proxy';
const ENABLE_PROXY = true;
const ALWAYS_PROXY_EXTERNAL = true;
const REQ_TIMEOUT_MS = 10000;
const MAX_RETRIES_PER_IMG = 2;

const PRELOAD_AHEAD = 6;
const PRELOAD_BACK  = 1;
const MAX_CONCURRENCY = 3;

let API_IDX = 0;
const API_ORIGIN = () => API_ORIGINS[API_IDX];

// ===== UI: скролл-трек и индикатор =====
let ticking=false, trackHide, indicatorHide;
scrollable.addEventListener('scroll', () => {
  if (!ticking) {
    requestAnimationFrame(()=>{
      updateThumb();
      scheduleAround(currentIndex()-1);
      ticking=false;
    });
    ticking=true;
  }
  track.style.opacity = 1;
  clearTimeout(trackHide);
  trackHide = setTimeout(()=>track.style.opacity=0, 800);
});

function updateThumb(){
  const viewH=scrollable.clientHeight, docH=scrollable.scrollHeight, trackH=track.clientHeight;
  const ratio=viewH/docH, thH=Math.max(ratio*trackH,20); thumb.style.height=thH+'px';
  const maxScroll=docH-viewH, maxMove=trackH-thH, top=maxScroll>0?(scrollable.scrollTop/maxScroll)*maxMove:0;
  thumb.style.transform=`translateY(${top}px)`;
}
document.addEventListener('click', e => {
  if (e.detail===0) return;
  const rect=scrollable.getBoundingClientRect(), y=e.clientY-rect.top, h=scrollable.clientHeight;
  if (y<h/3) scrollable.scrollBy({top:-h*0.8,behavior:'smooth'});
  else if (y>2*h/3) scrollable.scrollBy({top:h*0.8,behavior:'smooth'});
  else showPageIndicator();
});
function showPageIndicator(){ pageInd.textContent=`${currentIndex()}/${total}`; pageInd.style.opacity=1; clearTimeout(indicatorHide); indicatorHide=setTimeout(()=>pageInd.style.opacity=0,1200); }
function currentIndex(){ const mid=window.innerHeight/2; for(let i=0;i<wrappers.length;i++){ const r=wrappers[i].getBoundingClientRect(); if(r.top<=mid&&r.bottom>=mid) return i+1; } return 1; }

// ===== Сеть/утилиты =====
function toProxy(u){ return `${API_ORIGIN()}${API_PATH_IMG_PROXY}?u=${encodeURIComponent(u)}`; }

function normalizeUrl(u){
  try{
    const x=new URL(u, location.href);
    const isOur = (x.origin===API_ORIGIN());
    if (isOur) return u;
    if (ENABLE_PROXY && (ALWAYS_PROXY_EXTERNAL || x.protocol!=='https:')) return toProxy(u);
    return u;
  }catch{ return u; }
}

function fetchJSONWithTimeout(url, ms) {
  const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(),ms);
  return fetch(url,{signal:ctrl.signal,mode:'cors'})
    .finally(()=>clearTimeout(t))
    .then(async r=>{
      if(r.status===204)return[];
      if(!r.ok){
        let msg=''; try{const j=await r.json(); msg=j?.error||'';}catch{}
        const err=new Error(msg||`HTTP ${r.status}`);
        err.status=r.status; throw err;
      }
      return r.json();
    });
}

// Переключение между узлами + ретраи + PDF-фолбэк
async function resilientGetLinks(srcUrl, {preferPdf=false}={}){
  const qs = new URLSearchParams({ url: srcUrl });
  if (preferPdf) qs.set('prefer_pdf','1');
  let delay=400;

  for (let hop=0; hop<API_ORIGINS.length; hop++){
    const base = `${API_ORIGIN()}${API_PATH_GET_LINKS}?${qs.toString()}`;
    for (let i=0;i<3;i++){
      try{ return await fetchJSONWithTimeout(base, REQ_TIMEOUT_MS); }
      catch(e){
        const isNetwork = (e instanceof TypeError) || (e.name==='AbortError');
        const isRetryable = isNetwork || (e.status>=500 && e.status<600);
        if (!isRetryable) throw e;
        await new Promise(r=>setTimeout(r, delay));
        delay = Math.min(delay*2, 3000);
      }
    }
    API_IDX = Math.min(API_IDX+1, API_ORIGINS.length-1);
  }
  throw new Error('Сервис временно недоступен (все узлы недостижимы).');
}

// ===== Очередь предзагрузки картинок =====
const items=[];        // {wrapper,img,spinner,rawUrl,curUrl,state,retries,usedProxy}
const q=[]; let inflight=0;

function enqueue(i){ const it=items[i]; if(!it||it.state==='loaded'||it.state==='loading') return; if(!q.includes(i)) q.push(i); }
function processQueue(){ while(inflight<MAX_CONCURRENCY && q.length){ const i=q.shift(); const it=items[i]; if(!it||it.state==='loaded'||it.state==='loading') continue; loadIndex(i);} }
function scheduleAround(pivot){
  if(pivot<0)pivot=0;
  const s=Math.max(0,pivot-PRELOAD_BACK), e=Math.min(items.length-1,pivot+PRELOAD_AHEAD);
  for(let i=s;i<=e;i++) enqueue(i);
  processQueue();
}
function attachErrorCard(it, i){
  it.spinner?.remove();
  if (it.wrapper.querySelector('.error')) return;
  const err=document.createElement('div'); err.className='error';
  err.textContent='Не удалось загрузить — нажмите, чтобы повторить';
  err.style.cursor='pointer';
  err.onclick=()=>{ err.remove(); it.state='idle'; it.retries=0; it.curUrl=normalizeUrl(it.rawUrl); enqueue(i); processQueue(); };
  it.wrapper.append(err);
}
function cacheBust(u){
  try{ const x=new URL(u,location.href); x.searchParams.set('_', Date.now().toString(36)); return x.toString(); }
  catch{ return u+(u.includes('?')?'&':'?')+'_'+Date.now().toString(36); }
}
function loadIndex(i){
  const it=items[i]; if(!it) return;
  it.state='loading'; inflight++;
  const img=it.img;
  img.referrerPolicy='no-referrer'; img.decoding='async'; img.loading='eager';

  const trySet=(url)=>new Promise(res=>{
    let done=false;
    img.onload = ()=>{ if(done)return; done=true; it.spinner?.remove(); it.state='loaded'; img.style.opacity=1; inflight--; processQueue(); res(true); };
    img.onerror= ()=>{ if(done)return; done=true; res(false); };
    img.src=url;
  });

  const tryLoad=async()=>{
    if (await trySet(it.curUrl)) return true;
    if (ENABLE_PROXY && !it.usedProxy){ it.usedProxy=true; it.curUrl=toProxy(it.rawUrl); if(await trySet(it.curUrl)) return true; }
    while(it.retries<MAX_RETRIES_PER_IMG){ it.retries++; const busted=cacheBust(it.curUrl); if(await trySet(busted)) return true; }
    return false;
  };

  tryLoad().then(ok=>{ if(!ok){ it.state='error'; inflight--; processQueue(); attachErrorCard(it,i); }});
}

// ===== Основной запуск =====
document.addEventListener('DOMContentLoaded', () => {
  Telegram.WebApp.ready();
  Telegram.WebApp.disableVerticalSwipes?.();
  fetchImages();
});

async function fetchImages(){
  const src=new URLSearchParams(location.search).get('url');
  const container=document.getElementById('image-container');
  container.innerHTML='';
  if(!src){ container.innerHTML=`<div class="error">Не передан параметр <code>url</code>.</div>`; return; }

  try{
    let data = await resilientGetLinks(src);                    // 1) пробуем <img> с источника
    if (!data || !data.length) data = await resilientGetLinks(src, {preferPdf:true}); // 2) PDF

    if(!data || !data.length){ container.innerHTML=`<div class="error">Изображения не найдены.</div>`; return; }

    data.forEach(({image_url}, idx)=>{
      const w=document.createElement('div'); w.className='image-wrapper';
      const s=document.createElement('div'); s.className='spinner';
      const img=document.createElement('img'); w.append(s,img); container.append(w);
      items[idx]={ wrapper:w, img, spinner:s, rawUrl:image_url, curUrl:normalizeUrl(image_url), state:'idle', retries:0, usedProxy: ENABLE_PROXY && ALWAYS_PROXY_EXTERNAL };
    });

    wrappers = items.map(x=>x.wrapper); total=items.length;
    updateThumb();
    scheduleAround(0);
  }catch(e){
    container.innerHTML = `<div class="error">Ошибка загрузки: ${e.message}<br><button id="retry">Повторить</button></div>`;
    document.getElementById('retry')?.addEventListener('click', fetchImages);
  }
}
</script>



  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-M7R29TFD"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-TVWL57RTT6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date()); gtag('config', 'G-TVWL57RTT6');
  </script>
</body>
</html>
